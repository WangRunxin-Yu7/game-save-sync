# é…ç½®æ–‡ä»¶çƒ­é‡è½½åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä»ç°åœ¨å¼€å§‹ï¼Œåº”ç”¨æ”¯æŒ**é…ç½®æ–‡ä»¶çƒ­é‡è½½**åŠŸèƒ½ï¼å½“ä½ ä¿®æ”¹ `config.ini` æ–‡ä»¶åï¼Œåº”ç”¨ä¼šè‡ªåŠ¨æ£€æµ‹å˜åŒ–å¹¶é‡æ–°åŠ è½½é…ç½®ï¼Œ**æ— éœ€æ‰‹åŠ¨é‡å¯åº”ç”¨**ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

1. **è‡ªåŠ¨æ£€æµ‹é…ç½®å˜åŒ–** - æ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡é…ç½®æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹
2. **è‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®** - æ£€æµ‹åˆ°å˜åŒ–åè‡ªåŠ¨è°ƒç”¨ `reload_config()`
3. **è‡ªåŠ¨é‡å¯åŒæ­¥æµç¨‹** - é‡æ–°æ‰§è¡Œå¤‡ä»½ã€æ‹‰å–ã€æ¨é€ç­‰å¯åŠ¨æµç¨‹
4. **æ— ç¼åˆ‡æ¢æ¸¸æˆç›‘æ§** - è‡ªåŠ¨æ›´æ–°ç›‘æ§çš„æ¸¸æˆç›®å½•åˆ—è¡¨
5. **ä¿æŒåº”ç”¨è¿è¡Œ** - æ•´ä¸ªè¿‡ç¨‹åº”ç”¨ä¿æŒè¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨é‡å¯

## ğŸš€ ä½¿ç”¨æ–¹å¼

### é»˜è®¤å¯ç”¨ï¼ˆæ¨èï¼‰

åº”ç”¨é»˜è®¤å¯ç”¨é…ç½®çƒ­é‡è½½åŠŸèƒ½ï¼Œæ— éœ€ä»»ä½•é¢å¤–æ“ä½œï¼š

```bash
# Windows
build_game_save_sync.bat
åŒå‡»è¿è¡Œç”Ÿæˆçš„ .exe æ–‡ä»¶

# æˆ–ç›´æ¥è¿è¡Œæºç 
cd src
python main.py
```

### ç¦ç”¨é…ç½®çƒ­é‡è½½

å¦‚æœå‡ºäºæŸäº›åŸå› éœ€è¦ç¦ç”¨æ­¤åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ `--no-config-watch` å‚æ•°ï¼š

```bash
python main.py --no-config-watch
```

æˆ–ä¿®æ”¹å¯åŠ¨è„šæœ¬æ·»åŠ æ­¤å‚æ•°ã€‚

## ğŸ“ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: æ·»åŠ æ–°æ¸¸æˆå­˜æ¡£åŒæ­¥

**ä¹‹å‰çš„åšæ³•**:
1. ä¿®æ”¹ `config.ini` æ·»åŠ æ–°æ¸¸æˆé…ç½®
2. å‰å¾€ä»»åŠ¡ç®¡ç†å™¨æ‰¾åˆ°åº”ç”¨è¿›ç¨‹
3. ç»“æŸè¿›ç¨‹
4. é‡æ–°å¯åŠ¨åº”ç”¨

**ç°åœ¨çš„åšæ³•**:
1. ä¿®æ”¹ `config.ini` æ·»åŠ æ–°æ¸¸æˆé…ç½®
2. ç­‰å¾… 1-3 ç§’
3. âœ… **å®Œæˆï¼åº”ç”¨è‡ªåŠ¨é‡æ–°åŠ è½½é…ç½®**

### åœºæ™¯ 2: ä¿®æ”¹æ¸¸æˆå­˜æ¡£è·¯å¾„

**æ“ä½œæ­¥éª¤**:
1. æ‰“å¼€ `data/config.ini`
2. ä¿®æ”¹å¯¹åº”æ¸¸æˆçš„ `path` é…ç½®
3. ä¿å­˜æ–‡ä»¶
4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤é‡æ–°åŠ è½½æˆåŠŸ

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**:
```
2025-12-15 10:30:15 config_file_changed: path=E:/v_runxwang/æˆ‘çš„é¡¹ç›®/python/game-save-sync/data/config.ini
2025-12-15 10:30:15 config_reload_start
2025-12-15 10:30:15 config_reload_done
2025-12-15 10:30:15 app_restart
2025-12-15 10:30:16 app_restart_done
```

### åœºæ™¯ 3: è°ƒæ•´åŒæ­¥ç­–ç•¥

ä¿®æ”¹ä»¥ä¸‹é…ç½®æ—¶ä¹Ÿä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼š
- `poll_interval_minutes` - æ‹‰å–é—´éš”
- `debounce_ms` - é˜²æŠ–å»¶è¿Ÿ
- `max_backups` - æœ€å¤§å¤‡ä»½æ•°
- Git ç›¸å…³é…ç½®ï¼ˆremote, branch ç­‰ï¼‰

## ğŸ”§ å·¥ä½œåŸç†

```
1. åº”ç”¨å¯åŠ¨
   â””â”€> åŠ è½½é…ç½®
   â””â”€> å¯åŠ¨é…ç½®æ–‡ä»¶ç›‘æ§å™¨ (Watcher)
       â””â”€> æ¯ 2 ç§’æ£€æŸ¥ config.ini æ˜¯å¦å˜åŒ–

2. æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–
   â””â”€> è§¦å‘çƒ­é‡è½½å›è°ƒ
   â””â”€> å»¶è¿Ÿ 0.5 ç§’ï¼ˆç¡®ä¿æ–‡ä»¶å†™å…¥å®Œæˆï¼‰
   â””â”€> è·å–é‡å¯é”ï¼ˆé˜²æ­¢å¤šæ¬¡é‡å¯ï¼‰

3. æ‰§è¡Œçƒ­é‡è½½
   â”œâ”€> åœæ­¢æ¸¸æˆå­˜æ¡£ç›‘æ§å™¨
   â”œâ”€> é‡æ–°åŠ è½½é…ç½® (reload_config)
   â”œâ”€> é‡æ–°æ‰§è¡Œå¯åŠ¨æµç¨‹:
   â”‚   â”œâ”€> å¤‡ä»½æœ¬åœ°å­˜æ¡£
   â”‚   â”œâ”€> æ‹‰å–è¿œç¨‹å˜æ›´
   â”‚   â”œâ”€> åŒæ­¥æœ¬åœ°åˆ°ä»“åº“
   â”‚   â””â”€> æ¨é€åˆ°è¿œç¨‹
   â”œâ”€> é‡å¯å®šæ—¶å™¨
   â””â”€> é‡å¯æ¸¸æˆå­˜æ¡£ç›‘æ§å™¨

4. æ¢å¤æ­£å¸¸è¿è¡Œ
   â””â”€> ç»§ç»­ç›‘æ§é…ç½®æ–‡ä»¶å’Œæ¸¸æˆå­˜æ¡£
```

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### å®ç°æ–¹å¼

ä½¿ç”¨ç°æœ‰çš„ `Watcher` ç»„ä»¶ç›‘æ§é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼š

```python
# åœ¨ SyncApp.__init__ ä¸­
self._config_watcher = create_watcher(
    paths=[config_dir],
    callback=self._config_changed_callback,
    interval_ms=2000  # 2ç§’æ£€æŸ¥ä¸€æ¬¡
)
```

### é‡å¯é”æœºåˆ¶

é˜²æ­¢é…ç½®æ–‡ä»¶è¿ç»­å¤šæ¬¡ä¿®æ”¹å¯¼è‡´çš„å¤šæ¬¡é‡å¯ï¼š

```python
with self._restart_lock:
    if self._restarting:
        return  # å·²åœ¨é‡å¯ä¸­ï¼Œè·³è¿‡
    self._restarting = True
```

### ä¿ç•™å‘½ä»¤è¡Œå‚æ•°

é‡å¯æ—¶ä¿ç•™å¯åŠ¨æ—¶çš„å‘½ä»¤è¡Œå‚æ•°è¦†ç›–ï¼š

```python
# ä¿å­˜è¦†ç›–å‚æ•°
self._override_remote = override_remote
self._override_token = override_token
self._override_username = override_username
self._override_branch = override_branch

# é‡æ–°åŠ è½½æ—¶åº”ç”¨è¦†ç›–
if self._override_remote is not None:
    self.git_cfg["remote"] = self._override_remote
```

## ğŸ“Š æ€§èƒ½å½±å“

- **CPU å ç”¨**: å‡ ä¹å¯å¿½ç•¥ï¼ˆæ¯ 2 ç§’æ£€æŸ¥ä¸€æ¬¡æ–‡ä»¶çŠ¶æ€ï¼‰
- **å†…å­˜å ç”¨**: å¢åŠ çº¦ ~1KBï¼ˆé…ç½®ç›‘æ§å™¨å¯¹è±¡ï¼‰
- **ç£ç›˜ I/O**: æœ€å°ï¼ˆåªè¯»å–æ–‡ä»¶å…ƒæ•°æ®ï¼Œä¸è¯»å–å†…å®¹ï¼‰
- **é‡å¯è€—æ—¶**: é€šå¸¸ < 1 ç§’ï¼ˆå–å†³äºæ¸¸æˆæ•°é‡å’Œç½‘ç»œï¼‰

## ğŸ” æ—¥å¿—è¯´æ˜

### æ­£å¸¸è¿è¡Œæ—¥å¿—

```
config_watcher_started: path=E:/v_runxwang/æˆ‘çš„é¡¹ç›®/python/game-save-sync/data/config.ini
```
è¡¨ç¤ºé…ç½®ç›‘æ§å™¨å·²å¯åŠ¨ã€‚

### æ£€æµ‹åˆ°å˜åŒ–

```
config_file_changed: path=E:/v_runxwang/æˆ‘çš„é¡¹ç›®/python/game-save-sync/data/config.ini
config_reload_start
```
æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œå¼€å§‹é‡æ–°åŠ è½½ã€‚

### é‡æ–°åŠ è½½å®Œæˆ

```
config_reload_done
app_restart
backup_game_done: game=æ¸¸æˆ1 index=1 count=5
git_pull_ok: path=./repository branch=main
app_restart_done
```
é…ç½®é‡æ–°åŠ è½½å®Œæˆï¼Œåº”ç”¨å·²é‡å¯ã€‚

### é‡å¯è¢«è·³è¿‡

```
config_reload_skip: already_restarting
```
å·²ç»åœ¨é‡å¯ä¸­ï¼Œè·³è¿‡æ­¤æ¬¡é‡å¯è¯·æ±‚ã€‚

### é‡å¯å¤±è´¥

```
config_reload_error: err=æ–‡ä»¶ä¸å­˜åœ¨
```
é‡æ–°åŠ è½½é…ç½®æ—¶å‡ºé”™ï¼ˆé€šå¸¸æ˜¯é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼‰ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯

å¦‚æœä¿®æ”¹åçš„é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼ˆå¦‚ç¼ºå°‘å¿…è¦å­—æ®µï¼‰ï¼Œé‡æ–°åŠ è½½ä¼šå¤±è´¥ã€‚å»ºè®®ï¼š
- ä¿®æ”¹å‰å¤‡ä»½é…ç½®æ–‡ä»¶
- ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨è€Œé Word ç­‰å·¥å…·ç¼–è¾‘
- ç¡®ä¿ UTF-8 ç¼–ç 

### 2. æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

é‡å¯æ—¶ä¸ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆå¦‚ Git pushï¼‰ï¼Œè¿™äº›ä»»åŠ¡ä¼šç»§ç»­å®Œæˆã€‚

### 3. æ–‡ä»¶æ­£åœ¨å†™å…¥

ç›‘æ§å™¨ä¼šå»¶è¿Ÿ 0.5 ç§’å†æ‰§è¡Œé‡å¯ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶å†™å…¥å®Œæˆã€‚å¦‚æœä½¿ç”¨å¤§å‹é…ç½®æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´æ­¤å»¶è¿Ÿã€‚

### 4. ç£ç›˜ç©ºé—´

é‡å¯æ—¶ä¼šæ‰§è¡Œå¤‡ä»½æ“ä½œï¼Œç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ã€‚

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹æ³• 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
python test_config_reload.py
```

ç„¶åä¿®æ”¹ `data/config.ini` è§‚å¯Ÿè¾“å‡ºã€‚

### æ–¹æ³• 2: æ‰‹åŠ¨æµ‹è¯•

1. å¯åŠ¨åº”ç”¨
2. æ‰“å¼€ `logs/YYYY-MM-DD.log` æ—¥å¿—æ–‡ä»¶
3. ä¿®æ”¹ `data/config.ini`ï¼ˆä¾‹å¦‚æ·»åŠ ä¸€ä¸ªæ¸¸æˆï¼‰
4. ä¿å­˜æ–‡ä»¶
5. è§‚å¯Ÿæ—¥å¿—æ–‡ä»¶ï¼Œåº”è¯¥çœ‹åˆ° `config_reload_start` ç­‰æ—¥å¿—

### æ–¹æ³• 3: æ·»åŠ æ–°æ¸¸æˆæµ‹è¯•

**æ­¥éª¤**:
1. å¯åŠ¨åº”ç”¨
2. åœ¨ `config.ini` ä¸­æ·»åŠ :
   ```ini
   [game:æµ‹è¯•æ¸¸æˆ:1]
   path = C:\TestGame\saves
   allow = *.sav
   deny = 
   ```
3. ä¿å­˜æ–‡ä»¶
4. è§‚å¯Ÿæ—¥å¿—ç¡®è®¤æ–°æ¸¸æˆå·²è¢«ç›‘æ§

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **é…ç½®æ–‡ä»¶æƒé™**: å»ºè®®é™åˆ¶é…ç½®æ–‡ä»¶çš„å†™å…¥æƒé™ï¼Œé¿å…è¯¯ä¿®æ”¹
2. **ç›‘æ§è·¯å¾„**: åªç›‘æ§é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œä¸ç›‘æ§å…¶ä»–æ•æ„Ÿç›®å½•
3. **é‡å¯é”**: é˜²æ­¢æ¶æ„å¿«é€Ÿä¿®æ”¹é…ç½®å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½

## ğŸ†š ä¸æ‰‹åŠ¨é‡å¯çš„å¯¹æ¯”

| æ“ä½œ | æ‰‹åŠ¨é‡å¯ | é…ç½®çƒ­é‡è½½ |
|-----|---------|----------|
| ä¿®æ”¹é…ç½®æ–‡ä»¶ | âœ… | âœ… |
| å…³é—­åº”ç”¨ | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ |
| é‡æ–°å¯åŠ¨åº”ç”¨ | âœ… éœ€è¦ | âŒ è‡ªåŠ¨ |
| è€—æ—¶ | ~10-30ç§’ | ~1-3ç§’ |
| æ•°æ®ä¸¢å¤±é£é™© | ä¸­ç­‰ | ä½ |
| ç”¨æˆ·ä½“éªŒ | ä¸€èˆ¬ | ä¼˜ç§€ |

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å°æ­¥ä¿®æ”¹**: ä¸€æ¬¡ä¿®æ”¹ä¸€ä¸ªé…ç½®é¡¹ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
2. **è§‚å¯Ÿæ—¥å¿—**: ä¿®æ”¹åæŸ¥çœ‹æ—¥å¿—ç¡®è®¤ç”Ÿæ•ˆ
3. **ä¿ç•™å¤‡ä»½**: é‡è¦é…ç½®ä¿®æ”¹å‰å…ˆå¤‡ä»½
4. **æµ‹è¯•ç¯å¢ƒ**: åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯é…ç½®æ­£ç¡®æ€§
5. **é¿å…é¢‘ç¹ä¿®æ”¹**: è™½ç„¶æ”¯æŒçƒ­é‡è½½ï¼Œä½†é¢‘ç¹ä¿®æ”¹ä»ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜: ä¿®æ”¹é…ç½®åæ²¡æœ‰é‡æ–°åŠ è½½

**å¯èƒ½åŸå› **:
1. é…ç½®æ–‡ä»¶è·¯å¾„ä¸å¯¹ï¼ˆæ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ­£ç¡®çš„æ–‡ä»¶ï¼‰
2. é…ç½®çƒ­é‡è½½è¢«ç¦ç”¨ï¼ˆæ£€æŸ¥å¯åŠ¨å‚æ•°ï¼‰
3. åº”ç”¨å·²å´©æºƒï¼ˆæ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼‰

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ç¡®è®¤ç›‘æ§å™¨å·²å¯åŠ¨
2. ç¡®è®¤ä¿®æ”¹çš„æ˜¯åº”ç”¨å®é™…ä½¿ç”¨çš„é…ç½®æ–‡ä»¶
3. é‡å¯åº”ç”¨å¹¶è§‚å¯Ÿæ—¥å¿—

### é—®é¢˜: é‡æ–°åŠ è½½åæ–°é…ç½®æœªç”Ÿæ•ˆ

**å¯èƒ½åŸå› **:
1. é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯
2. æŸäº›é…ç½®é¡¹ä¸æ”¯æŒçƒ­é‡è½½ï¼ˆéœ€è¦å®Œå…¨é‡å¯ï¼‰

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
2. éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
3. å¿…è¦æ—¶å®Œå…¨é‡å¯åº”ç”¨

### é—®é¢˜: é‡æ–°åŠ è½½å¤±è´¥

**å¯èƒ½åŸå› **:
1. é…ç½®æ–‡ä»¶è¢«åˆ é™¤æˆ–ç§»åŠ¨
2. æƒé™ä¸è¶³æ— æ³•è¯»å–é…ç½®
3. é…ç½®æ ¼å¼ä¸¥é‡é”™è¯¯

**è§£å†³æ–¹æ³•**:
1. æ¢å¤é…ç½®æ–‡ä»¶
2. æ£€æŸ¥æ–‡ä»¶æƒé™
3. ä»å¤‡ä»½æ¢å¤æ­£ç¡®çš„é…ç½®

## ğŸ“š ç›¸å…³ API

### å…¬å¼€å‡½æ•°

```python
from config_util import reload_config, get_config_path

# æ‰‹åŠ¨é‡æ–°åŠ è½½é…ç½®ï¼ˆä¸æ¨èï¼Œåº”ç”¨ä¼šè‡ªåŠ¨åŠ è½½ï¼‰
reload_config()

# è·å–é…ç½®æ–‡ä»¶è·¯å¾„
config_path = get_config_path()
print(config_path)
```

### SyncApp å‚æ•°

```python
app = SyncApp(
    enable_config_watch=True  # å¯ç”¨é…ç½®çƒ­é‡è½½ï¼ˆé»˜è®¤ Trueï¼‰
)
```

## ğŸ‰ æ€»ç»“

é…ç½®æ–‡ä»¶çƒ­é‡è½½åŠŸèƒ½å¤§å¤§æå‡äº†åº”ç”¨çš„æ˜“ç”¨æ€§ï¼š
- âœ… æ— éœ€æ‰‹åŠ¨é‡å¯
- âœ… é…ç½®å³æ—¶ç”Ÿæ•ˆ
- âœ… ç”¨æˆ·ä½“éªŒä¼˜ç§€
- âœ… é™ä½æ“ä½œå¤æ‚åº¦
- âœ… å‡å°‘æ•°æ®ä¸¢å¤±é£é™©

äº«å—æ›´ä¾¿æ·çš„é…ç½®ç®¡ç†ä½“éªŒå§ï¼ğŸš€

---

**æœ€åæ›´æ–°**: 2025-12-15
**åŠŸèƒ½ç‰ˆæœ¬**: v1.1.0
